<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Face Search Tester</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin: 0 0 10px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #020617;
      border-radius: 10px;
      padding: 16px 18px 18px;
      margin-bottom: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 30px rgba(15,23,42,0.6);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    input[type="text"],
    input[type="password"],
    input[type="tel"],
    input[type="file"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      box-sizing: border-box;
      font-size: 14px;
    }
    input[type="file"] {
      padding: 4px;
    }
    input:focus {
      border-color: #6366f1;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: linear-gradient(135deg,#6366f1,#8b5cf6);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 12px;
      margin-bottom: 10px;
    }
    .badge {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(56,189,248,0.15);
      color: #7dd3fc;
      border: 1px solid rgba(56,189,248,0.4);
    }
    .status {
      font-size: 13px;
      margin-top: 8px;
      min-height: 18px;
      white-space: pre-wrap;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }
    .pill {
      font-size: 13px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #374151;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .result-card {
      background: #020617;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #1f2937;
    }
    .result-card img {
      width: 100%;
      border-radius: 6px;
      display: block;
      margin-bottom: 6px;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
    }
    .token-text {
      font-size: 11px;
      color: #9ca3af;
      word-break: break-all;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .mt-4 { margin-top: 8px; }
    .mt-6 { margin-top: 12px; }
    .highlight {
      color: #a5b4fc;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Face Search Tester</h1>
  <p class="small">
    Тестовый фронт для твоего Django API.<br>
    <span class="highlight">Важно:</span> бэкенд должен быть доступен по <code>http://localhost:8000/api</code>.
  </p>

  <!-- AUTH -->
  <div class="card">
    <div class="card-header">
      <h2>1. Авторизация фотографа</h2>
      <span class="badge">/api/auth/login/</span>
    </div>
    <div class="row">
      <div>
        <label>Username</label>
        <input type="text" id="login-username" placeholder="photo1">
      </div>
      <div>
        <label>Password</label>
        <input type="password" id="login-password" placeholder="••••••••">
      </div>
    </div>
    <button id="btn-login">Войти и получить токен</button>
    <div class="mt-4">
      <div class="small">Токен:</div>
      <div class="token-text" id="token-display">—</div>
    </div>
    <div id="login-status" class="status"></div>
  </div>

  <!-- CREATE SESSION -->
  <div class="card">
    <div class="card-header">
      <h2>2. Создание фотосессии</h2>
      <span class="badge">/api/sessions/</span>
    </div>
    <div class="row">
      <div>
        <label>Имя клиента</label>
        <input type="text" id="session-client-name" placeholder="Иван Иванов">
      </div>
      <div>
        <label>Телефон клиента</label>
        <input type="tel" id="session-client-phone" placeholder="+996...">
      </div>
    </div>
    <button id="btn-create-session">Создать сессию</button>
    <div class="mt-4 small">
      ID последней сессии: <span id="last-session-id" class="highlight">—</span><br>
      Код просмотра: <span id="last-view-code" class="highlight">—</span><br>
      Код скачивания: <span id="last-download-code" class="highlight">—</span>
    </div>
    <div id="session-status" class="status"></div>
  </div>

  <!-- BULK UPLOAD -->
  <div class="card">
    <div class="card-header">
      <h2>3. Массовая загрузка фотографий в сессию</h2>
      <span class="badge">/api/sessions/{id}/photos/bulk-upload/</span>
    </div>
    <div class="row">
      <div>
        <label>ID сессии</label>
        <input type="text" id="upload-session-id" placeholder="Например, 1">
      </div>
      <div>
        <label>Фотографии (можно выбрать много)</label>
        <input type="file" id="upload-images" accept="image/*" multiple>
      </div>
    </div>
    <button id="btn-upload">Загрузить фото</button>
    <div id="upload-status" class="status"></div>
  </div>

  <!-- FACE SEARCH -->
  <div class="card">
    <div class="card-header">
      <h2>4. Поиск по лицу</h2>
      <span class="badge">/api/search-by-face/</span>
    </div>
    <div class="row">
      <div>
        <label>Фото лица для поиска</label>
        <input type="file" id="search-image" accept="image/*">
      </div>
    </div>
    <button id="btn-search">Искать по лицу</button>
    <div id="search-status" class="status"></div>
    <div class="mt-6">
      <div class="flex">
        <span class="pill">Результаты:</span>
        <span class="small" id="search-count">0 найдено</span>
      </div>
      <div id="search-results" class="results-grid"></div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "http://localhost:8000/api";
  let authToken = null;

  function setStatus(id, msg, ok = true) {
    const el = document.getElementById(id);
    el.textContent = msg || "";
    el.className = "status " + (ok ? "ok" : "err");
  }

  function authHeaders() {
    if (!authToken) return {};
    return { "Authorization": "Token " + authToken };
  }

  // ===== 1. LOGIN =====
  document.getElementById("btn-login").addEventListener("click", async () => {
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value.trim();
    if (!username || !password) {
      setStatus("login-status", "Заполни логин и пароль", false);
      return;
    }

    setStatus("login-status", "Отправляем запрос...", true);

    try {
      const res = await fetch(API_BASE + "/auth/login/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      if (!res.ok) {
        setStatus("login-status", "Ошибка: " + (data.detail || res.status), false);
        return;
      }

      authToken = data.token;
      document.getElementById("token-display").textContent = authToken;
      setStatus("login-status", "Успешный вход", true);
    } catch (e) {
      console.error(e);
      setStatus("login-status", "Сетевая ошибка: " + e, false);
    }
  });

  // ===== 2. CREATE SESSION =====
  document.getElementById("btn-create-session").addEventListener("click", async () => {
    if (!authToken) {
      setStatus("session-status", "Сначала залогинься", false);
      return;
    }

    const client_name = document.getElementById("session-client-name").value.trim();
    const client_phone = document.getElementById("session-client-phone").value.trim();

    if (!client_name || !client_phone) {
      setStatus("session-status", "Заполни имя и телефон клиента", false);
      return;
    }

    setStatus("session-status", "Создаём сессию...", true);

    try {
      const res = await fetch(API_BASE + "/sessions/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...authHeaders(),
        },
        body: JSON.stringify({ client_name, client_phone })
      });

      const data = await res.json();
      if (!res.ok) {
        setStatus("session-status", "Ошибка: " + JSON.stringify(data), false);
        return;
      }

      document.getElementById("last-session-id").textContent = data.id;
      document.getElementById("last-view-code").textContent = data.view_code;
      document.getElementById("last-download-code").textContent = data.download_code;
      document.getElementById("upload-session-id").value = data.id;
      setStatus("session-status", "Сессия создана (id: " + data.id + ")", true);
    } catch (e) {
      console.error(e);
      setStatus("session-status", "Сетевая ошибка: " + e, false);
    }
  });

  // ===== 3. BULK UPLOAD =====
  document.getElementById("btn-upload").addEventListener("click", async () => {
    if (!authToken) {
      setStatus("upload-status", "Сначала залогинься", false);
      return;
    }

    const sessionId = document.getElementById("upload-session-id").value.trim();
    const input = document.getElementById("upload-images");
    const files = Array.from(input.files || []);

    if (!sessionId) {
      setStatus("upload-status", "Укажи ID сессии", false);
      return;
    }
    if (!files.length) {
      setStatus("upload-status", "Выбери хотя бы один файл", false);
      return;
    }

    setStatus("upload-status", "Загружаем " + files.length + " файлов...", true);

    try {
      const formData = new FormData();
      files.forEach(f => formData.append("images", f));  // поле "images" как в API

      const res = await fetch(`${API_BASE}/sessions/${sessionId}/photos/bulk-upload/`, {
        method: "POST",
        headers: {
          ...authHeaders(),
        },
        body: formData
      });

      const data = await res.json();
      if (!res.ok) {
        setStatus("upload-status", "Ошибка: " + JSON.stringify(data), false);
        return;
      }

      setStatus("upload-status", "Успешная загрузка: " + data.length + " фото", true);
    } catch (e) {
      console.error(e);
      setStatus("upload-status", "Сетевая ошибка: " + e, false);
    }
  });

  // ===== 4. FACE SEARCH =====
  document.getElementById("btn-search").addEventListener("click", async () => {
    if (!authToken) {
      setStatus("search-status", "Сначала залогинься", false);
      return;
    }

    const input = document.getElementById("search-image");
    const file = input.files[0];
    if (!file) {
      setStatus("search-status", "Выбери файл с лицом", false);
      return;
    }

    setStatus("search-status", "Ищем совпадения...", true);
    document.getElementById("search-results").innerHTML = "";
    document.getElementById("search-count").textContent = "0 найдено";

    try {
      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch(API_BASE + "/search-by-face/", {
        method: "POST",
        headers: {
          ...authHeaders(),
        },
        body: formData
      });

      const data = await res.json();
      if (!res.ok) {
        setStatus("search-status", "Ошибка: " + (data.detail || JSON.stringify(data)), false);
        return;
      }

      const matches = data.matches || [];
      document.getElementById("search-count").textContent = matches.length + " найдено";

      const container = document.getElementById("search-results");
      container.innerHTML = "";

      matches.forEach(m => {
        const card = document.createElement("div");
        card.className = "result-card";

        const img = document.createElement("img");
        img.src = m.image_url.startsWith("http")
          ? m.image_url
          : "http://localhost:8000" + m.image_url;

        const info = document.createElement("div");
        info.innerHTML = `
          <div class="small"><strong>Session ID:</strong> ${m.session_id}</div>
          <div class="small"><strong>Client:</strong> ${m.client_name}</div>
          <div class="small"><strong>Distance:</strong> ${m.distance.toFixed(4)}</div>
        `;

        card.appendChild(img);
        card.appendChild(info);
        container.appendChild(card);
      });

      setStatus("search-status", "Поиск завершён", true);
    } catch (e) {
      console.error(e);
      setStatus("search-status", "Сетевая ошибка: " + e, false);
    }
  });
</script>
</body>
</html>
